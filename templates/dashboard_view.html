{% extends "base.html" %}

{% block title %}{{ dashboard.name }} - Expense Tracker{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-tachometer-alt me-2"></i>{{ dashboard.name }}</h2>
        {% if dashboard.description %}
        <p class="text-muted mb-0">{{ dashboard.description }}</p>
        {% endif %}
    </div>
    <div>
        <a href="{{ url_for('dashboard_list') }}" class="btn btn-outline-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i>Back to Dashboards
        </a>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#shareDashboardModal">
            <i class="fas fa-user-plus me-1"></i>Invite
        </button>
    </div>
</div>

<!-- Dashboard Navigation -->
<ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="ingress-tab" data-bs-toggle="tab" data-bs-target="#ingress" type="button" role="tab">
            <i class="fas fa-upload me-1"></i>Data Ingress
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab">
            <i class="fas fa-calendar me-1"></i>Monthly Expenses
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly" type="button" role="tab">
            <i class="fas fa-chart-line me-1"></i>Yearly Overview
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="dashboardTabsContent">
    <!-- Ingress Tab -->
    <div class="tab-pane fade show active" id="ingress" role="tabpanel">
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload Data</h5>
                        <span class="badge bg-light text-primary d-none d-md-inline-flex align-items-center">
                            <i class="fas fa-shield-alt me-2"></i>Secure by design
                        </span>
                    </div>
                    <div class="card-body">
                        
                        <!-- Two Option Layout -->
                        <div class="row mb-4">
                            <!-- Option 1: Google Sheets Direct CSV Copy -->
                            <div class="col-md-6">
                                <div class="card option-card h-100" data-option="sheets">
                                    <div class="card-body text-center">
                                        <i class="fas fa-table fa-3x text-primary mb-3"></i>
                                        <h5>Google Sheets Copy</h5>
                                        <p class="text-muted mb-3">Directly paste CSV data from Google Sheets</p>
                                        <button class="btn btn-primary" data-option="sheets">
                                            <i class="fas fa-paste me-1"></i>Paste Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Option 2: AI Processing of PDF/CSV -->
                            <div class="col-md-6">
                                <div class="card option-card h-100" data-option="ai">
                                    <div class="card-body text-center">
                                        <i class="fas fa-robot fa-3x text-info mb-3"></i>
                                        <h5>AI Processing</h5>
                                        <p class="text-muted mb-3">Upload files and use AI for processing</p>
                                        <button class="btn btn-info" data-option="ai">
                                            <i class="fas fa-magic me-1"></i>Use AI
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Google Sheets Paste Area -->
                        <div id="sheetsPasteArea" class="d-none">
                            <h6>Paste from Google Sheets</h6>
                            <p class="text-muted mb-3">Copy and paste your CSV data from Google Sheets</p>
                            <textarea id="sheetsPasteText" class="form-control mb-3" rows="8" 
                                      placeholder="Paste your CSV data here from Google Sheets..."></textarea>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" id="processSheetsData">
                                    <i class="fas fa-play me-1"></i>Process Data
                                </button>
                                <button class="btn btn-outline-secondary" id="cancelSheets">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                            </div>
                        </div>
                        
                        
                        <!-- AI Chat Interface -->
                        <div id="aiUploadArea" class="d-none">
                            <h6>AI Assistant</h6>
                            <p class="text-muted mb-3">Upload files and chat with AI to process your expense data. The AI will maintain context throughout your session.</p>
                            
                            <!-- Chat Messages -->
                            <div id="aiChatMessages" class="mb-3" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem;">
                                <div class="chat-message assistant">
                                    <strong>AI Assistant:</strong> Hello! I can help you process your expense data. You can upload PDF bank statements or CSV files, and I'll extract and process the data for you. What would you like to do?
                                </div>
                            </div>
                            
                            <!-- Chat Input -->
                            <div class="input-group mb-3">
                                <input type="text" id="aiChatInput" class="form-control" placeholder="Describe what you want to do with your data...">
                                <button class="btn btn-success" id="sendAiMessage">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            
                            <!-- File Upload Area -->
                            <div class="border-dashed p-3 mb-3">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <i class="fas fa-file-upload text-muted me-2"></i>
                                        <span class="text-muted">Upload PDF or CSV file</span>
                                    </div>
                                    <input type="file" id="aiFileInput" accept=".csv,.pdf" class="d-none">
                                    <button type="button" class="btn btn-sm btn-outline-info" id="chooseFileBtn">
                                        <i class="fas fa-folder-open me-1"></i>Choose File
                                    </button>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Supported formats: CSV, PDF (bank statements)</small>
                                </div>
                            </div>
                            
                            <!-- PDF Extraction Options -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-cog me-2"></i>PDF Extraction Settings</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="pdfExtractionMethod" class="form-label">Extraction Method</label>
                                            <select class="form-select" id="pdfExtractionMethod">
                                                <option value="camelot" selected>Camelot (Recommended for tables)</option>
                                                <option value="pypdf">PyPDF (Fallback for text-heavy documents)</option>
                                            </select>
                                            <small class="form-text text-muted">
                                                Camelot is better for tables, PyPDF for text extraction
                                            </small>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="pdfPageNumbers" class="form-label">Page Numbers</label>
                                            <input type="text" class="form-control" id="pdfPageNumbers" placeholder="e.g., 1,3,5 or leave blank for all pages">
                                            <small class="form-text text-muted">
                                                Specify pages to extract (comma-separated numbers)
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" id="cancelAI">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                            </div>
                        </div>
                        
                        <div id="processingArea" class="d-none">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <p class="text-center">Processing PDF... This may take a few moments.</p>
                        </div>
                        
                        <div id="csvPreviewArea" class="d-none">
                            <h6>Extracted Data Preview</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered" id="csvPreviewTable">
                                    <!-- CSV preview will be populated here -->
                                </table>
                            </div>
                            
                            <!-- Editable CSV Table Section -->
                            <div id="editableCsvSection" class="d-none mt-4">
                                <h6>Editable Data Table</h6>
                                <p class="text-muted mb-3">Edit the table directly like Google Sheets. Make your changes and click Save when ready.</p>
                                <div id="editableCsvTable"></div>
                                <div class="mt-3">
                                    <button class="btn btn-success me-2" id="saveExpenses">
                                        <i class="fas fa-save me-1"></i>Save to Expenses
                                    </button>
                                    <button class="btn btn-outline-secondary" id="cancelEdit">
                                        <i class="fas fa-times me-1"></i>Cancel
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-primary me-2" id="saveCsv">
                                    <i class="fas fa-save me-1"></i>Save Data
                                </button>
                                <button class="btn btn-outline-primary" id="editCsv">
                                    <i class="fas fa-edit me-1"></i>Edit Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>How It Works</h5>
                    </div>
                    <div class="card-body">
                        <ol class="list-group list-group-numbered">
                            <li class="list-group-item border-0 px-0">
                                <strong>Upload PDF</strong> - Your bank statement is processed locally
                            </li>
                            <li class="list-group-item border-0 px-0">
                                <strong>Extract Data</strong> - Tables are converted to CSV format
                            </li>
                            <li class="list-group-item border-0 px-0">
                                <strong>AI Processing</strong> - Use natural language to transform data
                            </li>
                            <li class="list-group-item border-0 px-0">
                                <strong>Review & Save</strong> - Finalize and add to your dashboard
                            </li>
                        </ol>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Dashboard Members</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for member in dashboard.members %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <img src="{{ member.user.get_profile_picture() }}" alt="{{ member.user.name }}" class="rounded-circle me-2" width="30" height="30">
                                    {{ member.user.name }}
                                </div>
                                <span class="badge bg-{{ 'primary' if member.role == 'owner' else 'secondary' }}">
                                    {{ member.role }}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Edit Mode Settings -->
                <div class="card mt-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Edit Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Edit Mode</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="editMode" id="privateMode" value="private" checked>
                                <label class="form-check-label" for="privateMode">
                                    <i class="fas fa-lock me-1"></i>Private Mode
                                </label>
                                <small class="form-text text-muted d-block">
                                    Only you can edit your own expense entries
                                </small>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="editMode" id="publicMode" value="public">
                                <label class="form-check-label" for="publicMode">
                                    <i class="fas fa-unlock me-1"></i>Public Mode
                                </label>
                                <small class="form-text text-muted d-block">
                                    All dashboard members can edit any expense entries
                                </small>
                            </div>
                        </div>
                        <button class="btn btn-primary w-100" id="saveEditMode">
                            <i class="fas fa-save me-1"></i>Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Monthly Expenses Tab -->
    <div class="tab-pane fade" id="monthly" role="tabpanel">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Monthly Expenses</h5>
                        <div class="d-flex gap-2">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-user me-1"></i>All Users
                                </button>
                                <ul class="dropdown-menu" id="userDropdownMenu" aria-labelledby="userDropdown">
                                    <!-- User options will be populated here -->
                                </ul>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="monthDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-calendar me-1"></i>Select Month
                                </button>
                                <ul class="dropdown-menu" id="monthDropdownMenu" aria-labelledby="monthDropdown">
                                    <!-- Month options will be populated here -->
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="mobileTableActions" class="d-flex gap-2 mb-3 d-md-none">
                            <button class="btn btn-outline-primary btn-sm" id="mobileAddRow">
                                <i class="fas fa-plus me-1"></i>Add row
                            </button>
                            <button class="btn btn-outline-danger btn-sm" id="mobileRemoveRow">
                                <i class="fas fa-trash me-1"></i>Delete row
                            </button>
                            <button class="btn btn-success btn-sm" id="mobileSaveRow">
                                <i class="fas fa-save me-1"></i>Save row
                            </button>
                        </div>
                        <div id="monthlyExpensesTable" class="table-responsive">
                            <!-- Handsontable will be initialized here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Category Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div id="categoryPivotTable">
                            <!-- Pivot table will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Yearly Overview Tab -->
    <div class="tab-pane fade" id="yearly" role="tabpanel">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Yearly Expense Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Yearly overview showing aggregated expense data across all months.
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="yearlyTable">
                                <!-- Yearly data will be populated here -->
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Invite Dashboard Modal -->
<div class="modal fade" id="shareDashboardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Invite to Dashboard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Invite teammates by email to collaborate on this dashboard.</p>
                <div class="mb-3">
                    <label for="shareEmail" class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="shareEmail" placeholder="Enter email address">
                </div>
                <div class="mb-3">
                    <label for="invitationMessage" class="form-label">Optional Message</label>
                    <textarea class="form-control" id="invitationMessage" rows="3" placeholder="Add a personal message (optional)"></textarea>
                </div>
                <button class="btn btn-primary w-100" id="inviteUser">
                    <i class="fas fa-envelope me-1"></i>Send Invitation
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast container for inline notices -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="monthlyInfoToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4500" data-bs-autohide="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-info-circle me-2"></i>
                Interactive expense table â€” edit like Sheets; changes autosave.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
    <div id="securityToast" class="toast align-items-center text-bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4800" data-bs-autohide="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-shield-alt me-2"></i>
                Uploads are validated server-side with MIME checks, size limits, and encrypted storage.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.border-dashed {
    border: 2px dashed #dee2e6;
    border-radius: 0.375rem;
    transition: border-color 0.15s ease-in-out;
}
.border-dashed:hover {
    border-color: #0d6efd;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- jQuery (required for DataTables) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- PDF.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
<!-- Handsontable for interactive tables -->
<script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">
<!-- DataTables for yearly view -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">

<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
